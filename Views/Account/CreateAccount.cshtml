@model CreateAccountViewModel
@{
    ViewData["Title"] = "إنشاء حساب جديد";
}

<div class="container-custom">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Progress Bar -->
            <div class="card-custom mb-4">
                <div class="d-flex justify-content-center align-items-center">
                    <div class="progress-step completed">
                        <div class="step-icon">
                            <i class="fas fa-phone"></i>
                        </div>
                        <span>تأكيد الهاتف</span>
                    </div>
                    <div class="progress-line completed"></div>
                    <div class="progress-step active">
                        <div class="step-icon">
                            <i class="fas fa-user"></i>
                        </div>
                        <span>إنشاء الحساب</span>
                    </div>
                    <div class="progress-line"></div>
                    <div class="progress-step">
                        <div class="step-icon">
                            <i class="fas fa-check"></i>
                        </div>
                        <span>الانتهاء</span>
                    </div>
                </div>
            </div>

            <div class="card-custom">
                <div class="text-center mb-4">
                    <i class="fas fa-user-plus fa-3x text-primary mb-3"></i>
                    <h1 class="h3 text-primary">إنشاء حساب جديد</h1>
                    <p class="text-muted">أكمل بياناتك لإنشاء حسابك في السوق العكسي</p>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        رقم الهاتف المؤكد: <strong>@ViewBag.PhoneNumber</strong>
                    </div>
                </div>

                <form asp-action="CreateAccount" method="post" enctype="multipart/form-data" id="createAccountForm">
                    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                    <!-- Personal Information -->
                    <div class="form-section">
                        <h5 class="section-title">
                            <i class="fas fa-user me-2"></i>
                            المعلومات الشخصية
                        </h5>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label asp-for="FirstName" class="form-label">الاسم الأول *</label>
                                <input asp-for="FirstName" class="form-control" required>
                                <span asp-validation-for="FirstName" class="text-danger"></span>
                            </div>

                            <div class="col-md-6">
                                <label asp-for="LastName" class="form-label">اسم العائلة *</label>
                                <input asp-for="LastName" class="form-control" required>
                                <span asp-validation-for="LastName" class="text-danger"></span>
                            </div>

                            <div class="col-md-4">
                                <label asp-for="DateOfBirth" class="form-label">تاريخ الميلاد *</label>
                                <input asp-for="DateOfBirth" type="date" class="form-control" required>
                                <span asp-validation-for="DateOfBirth" class="text-danger"></span>
                            </div>

                            <div class="col-md-4">
                                <label asp-for="Gender" class="form-label">الجنس *</label>
                                <select asp-for="Gender" class="form-control" required>
                                    <option value="">اختر الجنس</option>
                                    <option value="ذكر">ذكر</option>
                                    <option value="أنثى">أنثى</option>
                                </select>
                                <span asp-validation-for="Gender" class="text-danger"></span>
                            </div>

                            <div class="col-md-4">
                                <label asp-for="Email" class="form-label">البريد الإلكتروني</label>
                                <input asp-for="Email" type="email" class="form-control" placeholder="اختياري">
                                <span asp-validation-for="Email" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Location Information -->
                    <div class="form-section">
                        <h5 class="section-title">
                            <i class="fas fa-map-marker-alt me-2"></i>
                            معلومات الموقع
                        </h5>

                        <div class="row g-3">
                            <div class="col-md-4">
                                <label asp-for="City" class="form-label">المحافظة *</label>
                                <select asp-for="City" class="form-control" required>
                                    <option value="">اختر المحافظة</option>
                                    <option value="بغداد">بغداد</option>
                                    <option value="البصرة">البصرة</option>
                                    <option value="أربيل">أربيل</option>
                                    <option value="النجف">النجف</option>
                                    <option value="كربلاء">كربلاء</option>
                                    <option value="الموصل">الموصل</option>
                                    <option value="السليمانية">السليمانية</option>
                                    <option value="بابل">بابل</option>
                                    <option value="دهوك">دهوك</option>
                                    <option value="كركوك">كركوك</option>
                                    <option value="الأنبار">الأنبار</option>
                                    <option value="ديالى">ديالى</option>
                                    <option value="صلاح الدين">صلاح الدين</option>
                                    <option value="واسط">واسط</option>
                                    <option value="ذي قار">ذي قار</option>
                                    <option value="المثنى">المثنى</option>
                                    <option value="القادسية">القادسية</option>
                                    <option value="ميسان">ميسان</option>
                                </select>
                                <span asp-validation-for="City" class="text-danger"></span>
                            </div>

                            <div class="col-md-4">
                                <label asp-for="District" class="form-label">المنطقة *</label>
                                <input asp-for="District" class="form-control" placeholder="مثال: الكرادة، المعقل" required>
                                <span asp-validation-for="District" class="text-danger"></span>
                            </div>

                            <div class="col-md-4">
                                <label asp-for="Location" class="form-label">العنوان التفصيلي</label>
                                <input asp-for="Location" class="form-control" placeholder="الشارع، رقم البناء (اختياري)">
                            </div>
                        </div>
                    </div>

                    <!-- Account Type -->
                    <div class="form-section">
                        <h5 class="section-title">
                            <i class="fas fa-user-tag me-2"></i>
                            نوع الحساب
                        </h5>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="account-type-card" data-type="1">
                                    <div class="card-body text-center">
                                        <i class="fas fa-shopping-cart fa-3x text-primary mb-3"></i>
                                        <h5>مشتري</h5>
                                        <p class="text-muted">أريد إضافة طلبات والحصول على عروض من المتاجر</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="account-type-card" data-type="2">
                                    <div class="card-body text-center">
                                        <i class="fas fa-store fa-3x text-success mb-3"></i>
                                        <h5>بائع</h5>
                                        <p class="text-muted">أملك متجر وأريد تلقي طلبات من العملاء</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <input asp-for="UserType" type="hidden" id="userTypeInput">
                        <span asp-validation-for="UserType" class="text-danger"></span>
                    </div>

                    <!-- Store Information (for sellers) -->
                    <div id="storeInfo" class="form-section" style="display: none;">
                        <h5 class="section-title">
                            <i class="fas fa-store me-2"></i>
                            معلومات المتجر
                        </h5>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label asp-for="StoreName" class="form-label">اسم المتجر *</label>
                                <input asp-for="StoreName" class="form-control" placeholder="اسم متجرك">
                                <span asp-validation-for="StoreName" class="text-danger"></span>
                            </div>

                            <div class="col-md-6">
                                <label asp-for="StoreCategories" class="form-label">فئات المتجر *</label>
                                <select asp-for="StoreCategories" class="form-control" multiple id="storeCategoriesSelect">
                                    @foreach (var category in ViewBag.Categories as List<Category>)
                                    {
                                        <option value="@category.Id">@category.Name</option>
                                    }
                                </select>
                                <div class="form-text">اختر الفئات التي يتخصص بها متجرك (يمكن اختيار أكثر من فئة)</div>
                                <span asp-validation-for="StoreCategories" class="text-danger"></span>
                            </div>

                            <div class="col-12">
                                <label asp-for="StoreDescription" class="form-label">وصف المتجر</label>
                                <textarea asp-for="StoreDescription" class="form-control" rows="3"
                                          placeholder="اكتب وصف مختصر عن متجرك ونشاطك..."></textarea>
                                <span asp-validation-for="StoreDescription" class="text-danger"></span>
                            </div>

                            <div class="col-md-4">
                                <label asp-for="WebsiteUrl1" class="form-label">رابط الموقع الأول</label>
                                <input asp-for="WebsiteUrl1" class="form-control" placeholder="https://example.com">
                                <span asp-validation-for="WebsiteUrl1" class="text-danger"></span>
                            </div>

                            <div class="col-md-4">
                                <label asp-for="WebsiteUrl2" class="form-label">رابط الموقع الثاني</label>
                                <input asp-for="WebsiteUrl2" class="form-control" placeholder="https://facebook.com/yourstore">
                                <span asp-validation-for="WebsiteUrl2" class="text-danger"></span>
                            </div>

                            <div class="col-md-4">
                                <label asp-for="WebsiteUrl3" class="form-label">رابط الموقع الثالث</label>
                                <input asp-for="WebsiteUrl3" class="form-control" placeholder="https://instagram.com/yourstore">
                                <span asp-validation-for="WebsiteUrl3" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Profile Image -->
                    <div class="form-section">
                        <h5 class="section-title">
                            <i class="fas fa-camera me-2"></i>
                            صورة الملف الشخصي
                        </h5>

                        <div class="row g-3">
                            <div class="col-12">
                                <label asp-for="ProfileImage" class="form-label">اختر صورة شخصية</label>
                                <input asp-for="ProfileImage" type="file" class="form-control" accept="image/*"
                                       onchange="previewProfileImage(this)">
                                <div class="form-text">اختياري - يفضل صورة واضحة بحجم مناسب (أقل من 5 ميجابايت)</div>
                                <span asp-validation-for="ProfileImage" class="text-danger"></span>

                                <div id="imagePreview" class="mt-3" style="display: none;">
                                    <img id="preview" class="rounded-circle" style="width: 120px; height: 120px; object-fit: cover;" alt="معاينة الصورة">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Submit Section -->
                    <div class="form-section">
                        <div class="d-flex justify-content-between align-items-center">
                            <a href="/Account/Login" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-right me-2"></i>
                                العودة
                            </a>
                            <button type="submit" class="btn btn-custom btn-lg" id="submitBtn">
                                <i class="fas fa-user-plus me-2"></i>
                                إنشاء الحساب
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    .form-section {
        margin-bottom: 2rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid var(--border-color);
    }

        .form-section:last-child {
            border-bottom: none;
        }

    .section-title {
        color: var(--primary-color);
        margin-bottom: 1.5rem;
        font-weight: 600;
    }

    .progress-step {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        flex: 1;
    }

    .step-icon {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #e9ecef;
        color: #6c757d;
        margin-bottom: 0.5rem;
        transition: all 0.3s ease;
    }

    .progress-step.completed .step-icon {
        background: var(--primary-color);
        color: white;
    }

    .progress-step.active .step-icon {
        background: var(--secondary-color);
        color: white;
    }

    .progress-line {
        height: 2px;
        background: #e9ecef;
        flex: 1;
        margin: 25px 20px 0;
        transition: all 0.3s ease;
    }

        .progress-line.completed {
            background: var(--primary-color);
        }

    .account-type-card {
        border: 2px solid var(--border-color);
        border-radius: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        height: 100%;
    }

        .account-type-card:hover {
            border-color: var(--primary-color);
            box-shadow: 0 5px 15px rgba(44, 90, 160, 0.1);
        }

        .account-type-card.selected {
            border-color: var(--primary-color);
            background: rgba(44, 90, 160, 0.05);
        }

        .account-type-card .card-body {
            padding: 2rem;
        }

    #storeCategoriesSelect {
        min-height: 120px;
    }

    @@media (max-width: 768px) {
        .progress-step span

    {
        font-size: 0.8rem;
    }

    .progress-line {
        margin: 25px 10px 0;
    }

    }
</style>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Account type selection
            document.querySelectorAll('.account-type-card').forEach(card => {
                card.addEventListener('click', function() {
                    // Remove selected class from all cards
                    document.querySelectorAll('.account-type-card').forEach(c => {
                        c.classList.remove('selected');
                    });

                    // Add selected class to clicked card
                    this.classList.add('selected');

                    // Set hidden input value
                    const userType = this.getAttribute('data-type');
                    document.getElementById('userTypeInput').value = userType;

                    // Show/hide store information
                    const storeInfo = document.getElementById('storeInfo');
                    if (userType === '2') { // Seller
                        storeInfo.style.display = 'block';
                        // Make store fields required
                        document.querySelector('[name="StoreName"]').required = true;
                        document.querySelector('[name="StoreCategories"]').required = true;
                    } else {
                        storeInfo.style.display = 'none';
                        // Remove required from store fields
                        document.querySelector('[name="StoreName"]').required = false;
                        document.querySelector('[name="StoreCategories"]').required = false;
                    }
                });
            });

            // Form validation
            document.getElementById('createAccountForm').addEventListener('submit', function(e) {
                const userType = document.getElementById('userTypeInput').value;
                if (!userType) {
                    e.preventDefault();
                    showAlert('يرجى اختيار نوع الحساب', 'warning');
                    return false;
                }

                // Validate store information for sellers
                if (userType === '2') {
                    const storeName = document.querySelector('[name="StoreName"]').value;
                    const storeCategories = document.querySelector('[name="StoreCategories"]').selectedOptions;

                    if (!storeName.trim()) {
                        e.preventDefault();
                        showAlert('يرجى إدخال اسم المتجر', 'warning');
                        return false;
                    }

                    if (storeCategories.length === 0) {
                        e.preventDefault();
                        showAlert('يرجى اختيار فئة واحدة على الأقل للمتجر', 'warning');
                        return false;
                    }
                }

                // Show loading state
                const submitBtn = document.getElementById('submitBtn');
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> جاري إنشاء الحساب...';
            });

            // Set minimum date for date of birth (18 years ago)
            const dateInput = document.querySelector('[name="DateOfBirth"]');
            const eighteenYearsAgo = new Date();
            eighteenYearsAgo.setFullYear(eighteenYearsAgo.getFullYear() - 18);
            dateInput.max = eighteenYearsAgo.toISOString().split('T')[0];

            // Set maximum date (100 years ago)
            const hundredYearsAgo = new Date();
            hundredYearsAgo.setFullYear(hundredYearsAgo.getFullYear() - 100);
            dateInput.min = hundredYearsAgo.toISOString().split('T')[0];
        });

        function previewProfileImage(input) {
            const preview = document.getElementById('preview');
            const previewContainer = document.getElementById('imagePreview');

            if (input.files && input.files[0]) {
                const file = input.files[0];

                // Check file size (5MB limit)
                if (file.size > 5 * 1024 * 1024) {
                    showAlert('حجم الصورة كبير جداً. يجب أن يكون أقل من 5 ميجابايت', 'warning');
                    input.value = '';
                    previewContainer.style.display = 'none';
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    previewContainer.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                previewContainer.style.display = 'none';
            }
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                <i class="fas fa-${type === 'warning' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            const container = document.querySelector('.container-custom');
            container.insertBefore(alertDiv, container.firstChild);

            // Auto remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);

            // Scroll to alert
            alertDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    </script>
}